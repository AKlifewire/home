{
 "Resources": {
  "AlarmTopicD01E77F9": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Smart Home Alarms (dev)",
    "TopicName": "SmartHomeAlarms-dev"
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlarmTopic/Resource"
   }
  },
  "AlarmTopicadminexamplecom8E3778D7": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": "admin@example.com",
    "Protocol": "email",
    "TopicArn": {
     "Ref": "AlarmTopicD01E77F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlarmTopic/admin@example.com/Resource"
   }
  },
  "IoTAlertRoleB5740132": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "iot.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/IoTAlertRole/Resource"
   }
  },
  "IoTSecurityProfile": {
   "Type": "AWS::IoT::SecurityProfile",
   "Properties": {
    "AlertTargets": {
     "SNS": {
      "AlertTargetArn": {
       "Ref": "AlarmTopicD01E77F9"
      },
      "RoleArn": {
       "Fn::GetAtt": [
        "IoTAlertRoleB5740132",
        "Arn"
       ]
      }
     }
    },
    "Behaviors": [
     {
      "Criteria": {
       "ComparisonOperator": "greater-than",
       "ConsecutiveDatapointsToAlarm": 1,
       "ConsecutiveDatapointsToClear": 1,
       "Value": {
        "Count": "10240"
       }
      },
      "Metric": "aws:message-byte-size",
      "Name": "MessageSizeLimit"
     },
     {
      "Criteria": {
       "ComparisonOperator": "greater-than",
       "ConsecutiveDatapointsToAlarm": 1,
       "ConsecutiveDatapointsToClear": 1,
       "DurationSeconds": 60,
       "Value": {
        "Count": "100"
       }
      },
      "Metric": "aws:num-messages-received",
      "Name": "MessageRateLimit"
     },
     {
      "Criteria": {
       "ComparisonOperator": "greater-than",
       "ConsecutiveDatapointsToAlarm": 1,
       "ConsecutiveDatapointsToClear": 1,
       "DurationSeconds": 60,
       "Value": {
        "Count": "10"
       }
      },
      "Metric": "aws:num-connection-attempts",
      "Name": "ConnectionAttempts"
     }
    ],
    "SecurityProfileDescription": "Security profile for Smart Home IoT devices",
    "SecurityProfileName": "SmartHomeSecurityProfile-dev"
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/IoTSecurityProfile"
   }
  },
  "AlertProcessorFunctionServiceRole36330820": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlertProcessorFunction/ServiceRole/Resource"
   }
  },
  "AlertProcessorFunctionServiceRoleDefaultPolicy49F362E7": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "AlarmTopicD01E77F9"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "AlertProcessorFunctionServiceRoleDefaultPolicy49F362E7",
    "Roles": [
     {
      "Ref": "AlertProcessorFunctionServiceRole36330820"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlertProcessorFunction/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "AlertProcessorFunction53E18110": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-703671935952-us-east-1",
     "S3Key": "e1bc105be636f99d58d1b06958fab4a6f5c00b48b5a51c3a620ac7449ccc1158.zip"
    },
    "Description": "Processes IoT alerts and takes action",
    "Environment": {
     "Variables": {
      "STAGE": "dev",
      "ALARM_TOPIC_ARN": {
       "Ref": "AlarmTopicD01E77F9"
      }
     }
    },
    "FunctionName": "SmartHomeApp-dev-lambda-alert-processor",
    "Handler": "monitoring.processAlert",
    "Role": {
     "Fn::GetAtt": [
      "AlertProcessorFunctionServiceRole36330820",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Timeout": 30
   },
   "DependsOn": [
    "AlertProcessorFunctionServiceRoleDefaultPolicy49F362E7",
    "AlertProcessorFunctionServiceRole36330820"
   ],
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlertProcessorFunction/Resource",
    "aws:asset:path": "asset.e1bc105be636f99d58d1b06958fab4a6f5c00b48b5a51c3a620ac7449ccc1158",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "LambdaErrorsAlarm8ED74A7D": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlarmTopicD01E77F9"
     }
    ],
    "AlarmDescription": {
     "Fn::Join": [
      "",
      [
       "Alert when ",
       {
        "Ref": "AlertProcessorFunction53E18110"
       },
       " has errors"
      ]
     ]
    },
    "AlarmName": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "AlertProcessorFunction53E18110"
       },
       "-Errors-dev"
      ]
     ]
    },
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": {
       "Ref": "AlertProcessorFunction53E18110"
      }
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 60,
    "Statistic": "Sum",
    "Threshold": 1,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/LambdaErrorsAlarm/Resource"
   }
  },
  "SmartHomeDashboard3CD47649": {
   "Type": "AWS::CloudWatch::Dashboard",
   "Properties": {
    "DashboardBody": {
     "Fn::Join": [
      "",
      [
       "{\"widgets\":[{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":0,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Lambda Errors\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/Lambda\",\"Errors\",\"FunctionName\",\"",
       {
        "Ref": "AlertProcessorFunction53E18110"
       },
       "\",{\"period\":60,\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":12,\"y\":0,\"properties\":{\"view\":\"timeSeries\",\"title\":\"IoT Messages\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/IoT\",\"PublishIn.Success\",{\"period\":60,\"stat\":\"Sum\"}]],\"yAxis\":{}}}]}"
      ]
     ]
    },
    "DashboardName": "SmartHome-dev-Dashboard"
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/SmartHomeDashboard/Resource"
   }
  },
  "AlarmTopicArnParam080FDAB1": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "Description": "SNS topic ARN for alarms",
    "Name": "/dev/monitoring/alarmTopicArn",
    "Type": "String",
    "Value": {
     "Ref": "AlarmTopicD01E77F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/AlarmTopicArnParam/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/61UTU/cMBD9LfhYmRSW9tC97ZZWqlTKlkVwWCE0aw/JgGNH9pjVKsp/r5zEYSlCvfRk+83Xm5mXzIrTL5+LkyPYhWOln44NbYt2zaCeJOzCfRtsKNpr15DatILT+QtqFHPxQUihKTQG9hPS3cmvD7b3luu4DcpTw+RsDh3D0OrGkeXx2XjHTjkj5gJrICOkeCDD6FfOkNqPXofQLXF1gSFAiUuns4dG0D+RGf3viPGQ0SGXThLURXvlDG5aASHEGvVyL+ataDxZRQ2YhVIuTvwGnxSwUCnDkFiKGiyUqHtKhEHMN3ed/N8p21fYfuFH36GU1tdulUvkcW3a0coMqvphDVmcbOKD+Iexn1iiJgc8oVPAtUuWN3newlqvGRhrtBxGSn3iIWcnyXGRNoMqeuL9yrsHMigN1FsNRfs9WjUqx0fLNElOOZ2vFVht0I+v5OMiTxJ7Ju9sKj+pY5JAVtRY40W+A/Fvh7F99wddvWPse8ukOxnO7iEE5FAs0iHDWbGM6gl5CQE3d1IZF/UOWFVFuzDg67RnZJ8+kVbswFuyZciq4MpjqJzRublnMBFSpRV6cjpkVaVM52/67OGDr1a5ugFPwdnLBj2wm0boEfiCQiBbngODmAvreOkRVEW2zPPpCWfdvmy2h+U5hGrrwOtNK3S+/z3hW9IlDrp43aycnjezDJDmKm8cqaw4j2Wa+1SzkyHU6fflyZYr8FAjo9+0osn3gzGE3usGTMR3JDIqNsd2nbzC4KJXOC1e9vtdM5Rky+R9GbmJ3EnrNBaP4ePzbFacfipOjh4D0fGo5eJqOP8A/H/Km30FAAA="
   },
   "Metadata": {
    "aws:cdk:path": "dev-MonitoringStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "AlarmTopicArn": {
   "Description": "SNS topic ARN for alarms",
   "Value": {
    "Ref": "AlarmTopicD01E77F9"
   },
   "Export": {
    "Name": "AlarmTopicArn-dev"
   }
  },
  "SecurityProfileName": {
   "Description": "IoT Device Defender security profile name",
   "Value": "SmartHomeSecurityProfile-dev",
   "Export": {
    "Name": "SecurityProfileName-dev"
   }
  },
  "DashboardName": {
   "Description": "CloudWatch dashboard name",
   "Value": {
    "Ref": "SmartHomeDashboard3CD47649"
   },
   "Export": {
    "Name": "DashboardName-dev"
   }
  },
  "ExportsOutputRefAlarmTopicD01E77F99DF7FB73": {
   "Value": {
    "Ref": "AlarmTopicD01E77F9"
   },
   "Export": {
    "Name": "dev-MonitoringStack:ExportsOutputRefAlarmTopicD01E77F99DF7FB73"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}